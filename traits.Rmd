---
title: "Traits"
author: ""
output: 
  pdf_document:
    highlight: breezedark
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(readxl)
```

```{r}
normalized_data <- read_excel("normalized_data.xlsx")
```

```{r}
source("R/fct_derived_traits.R")
```

```{r}
human_IgG_traits_ui <- c(
  "Fucosylation of complex-type glycans",
  "Bisection of complex-type glycans",
  "Galactosylation of complex-type glycans",
  "Sialylation of complex type-glycans",
  "Percentage of monoantennary complex-type glycans",
  "Percentage of hybrid-type glycans",
  "Oligomannose-type glycans: average number of mannoses"
  # (5 * H5N2 + 6 * H6N2 + ...) / (H5N2 + H6N2 + ...)
)

human_IgG_traits <- c(
  "fucosylation",
  "bisection",
  "galactosylation",
  "sialylation",
  "mono_antennary",
  "hybrid",
  "high_mannose"
)
```

```{r}
human_IgG_clusters <- c("IgGI", "IgGII")
# normalized_data also contains IgGIsil, but want to calculate for IgGI and IgGII
```

```{r}
load("./data/human_IgG_ref.rda")
```

```{r}
generate_formula <- function(cluster, cluster_ref_df, target_trait) {
  
  # Get the glycans that should be used for calculating the trait
  df <- cluster_ref_df %>% 
    dplyr::select(glycan, tidyselect::all_of(target_trait)) %>% 
    dplyr::filter(!!rlang::sym(target_trait) != 0)
  
  # Create a string with the right hand side of the formula
  formula_string <- paste0(df[[target_trait]], " * ", df$glycan, collapse = " + ")
  
  # Collect terms and coefficients
  terms <- strsplit(formula_string, " \\+ ")[[1]]
  coefficients <- sapply(strsplit(terms, " \\* "), `[`, 1)
  unique_coefficients <- unique(coefficients)
  
  # Group terms by coefficients
  grouped_terms <- lapply(unique_coefficients, function(coeff) {
    coeff_indices <- which(coefficients == coeff)
    terms_with_coeff <- terms[coeff_indices]
    if (length(terms_with_coeff) > 1) {
      paste0(
        coeff, 
        " * (", 
        paste(gsub(".* \\* ", "", terms_with_coeff), collapse = " + "),
        ")"
      )
    } else {
      terms_with_coeff
    }
  })
  
  # Reconstruct cleaned formula string with grouped terms
  clean_formula_string <- paste(unlist(grouped_terms), collapse = " + ")
  
  # Add the left hand side of the formula
  final_formula_string <- ifelse(
    # If there are no glycans for the trait, than the formula is " * "
    # In that case the value should just be zero.
    test = clean_formula_string == " * ",
    yes = paste0(cluster, "_", target_trait, " = ", "0"),
    no = paste0(cluster, "_", target_trait, " = ", clean_formula_string)
  )
  
  return(final_formula_string)
}

generate_formula("IgGI", IgGI_ref, "high_mannose")
```

```{r}
# Loop over the chosen clusters
for (c in human_IgG_clusters) {
  # Get the normalized data for the cluster
  cluster_normalized_data <- normalized_data %>% 
    dplyr::filter(cluster == c)
  # Get all analytes/glycans in the cluster
  cluster_analytes <- unique(cluster_normalized_data$analyte)
  cluster_glycans <- stringr::str_remove(cluster_analytes, paste0(c, "1"))
  # Get a subset of the reference file with only the passing analytes
  cluster_ref <- human_IgG_ref %>% 
    dplyr::filter(glycan %in% cluster_glycans)
  # Loop over the chosen traits
  for (trait in chosen_human_IgG_traits) {
    cluster_
  }
  
}
```

```{r}
# For testing one clusters
IgGI_normalized_data <- normalized_data %>% dplyr::filter(cluster == "IgGI")

IgGI_analytes <- unique(IgGI_normalized_data$analyte)
IgGI_glycans <- stringr::str_remove(IgGI_analytes, paste0("IgGI", "1"))

IgGI_ref <- human_IgG_ref %>% 
  dplyr::filter(glycan %in% IgGI_glycans)

test <- generate_formula(IgGI_ref, "bisection")

# # Loop over the chosen traits
# for (trait in chosen_human_IgG_traits) {
#   # Create a formula for the trait
#   
# }
```

Implement a check for when there are glycans in the cluster data that are not present in the reference file.
