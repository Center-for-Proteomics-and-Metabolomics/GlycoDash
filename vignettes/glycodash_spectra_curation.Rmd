---
title: "glycodash_spectra_curation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{glycodash_spectra_curation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}

#library(glycodash)
devtools::load_all()

data("long_data")
```

```{r check_criteria}

long_data <- define_clusters(long_data,
                             clusters_regex = "IgGI1")

to_replace <- sample(1:69888, 69888/2)
long_data$cluster[to_replace] <- "IgG2"

checks <- summarize_spectra_checks(data = long_data,
                                   min_ppm_deviation = -20,
                                   max_ppm_deviation = 20,
                                   max_ipq = 0.2,
                                   min_sn = 9)

cut_offs <- calculate_cut_offs(checks,
                               group_to_filter = "Spike",
                               sample_type_to_filter = "CN") %>% 
  dplyr::ungroup(.) %>% 
  dplyr::select(-c(sample_type, group))

spectra_check <- dplyr::left_join(checks, cut_offs, by = "cluster") %>% 
  dplyr::ungroup(.)
  
passing_spectra <- spectra_check %>% 
    dplyr::filter((passing_proportion > cut_off_prop) & (sum_intensity > cut_off_sum_int))
  
long_data <- long_data %>% 
    dplyr::mutate(passed_curation = dplyr::case_when(
      sample_name %in% passing_spectra$sample_name ~ TRUE,
      TRUE ~ FALSE))

no_NAs <- long_data %>% 
    dplyr::filter(dplyr::if_all(.cols = c(mass_accuracy_ppm,
                                          isotopic_pattern_quality,
                                          sn),
                                .fns = ~ !is.na(.x)))
if (all(no_NAs$passed_curation == FALSE)) {
    warning("None of the spectra passed curation.")
  } else {
    if (all(no_NAs$passed_curation == TRUE)) {
      warning("All spectra passed curation.")
    }
  }


  data <- data %>% 
    dplyr::mutate(passed_curation = dplyr::case_when(
      sample_name %in% passing_spectra$sample_name ~ TRUE,
      TRUE ~ FALSE))
  
  no_NAs <- data %>% 
    dplyr::filter(dplyr::across(.cols = c(mass_accuracy_ppm,
                                          isotopic_pattern_quality,
                                          sn),
                                .fns = ~ !is.na(.x)))

wrong_data <- long_data %>% dplyr::select(-c(sample_name, group))
spectra_check <- summarize_spectra_checks(data = long_data,
                                min_ppm_deviation = -20,
                                max_ppm_deviation = 20,
                                max_ipq = 0.2,
                                min_sn = 9)

calculate_cut_offs(spectra_check, "Spike", "CN")

# Now I'm using the negative controls that were uncalibrated (or for other reason NA)
# as 0 in the calculation of cut-offs (because I replace NAs in the criteria check 
# with FALSE). Is that what we want?

# Function to calculate the population standard deviation.

curate_spectra(data = long_data,
               min_ppm_deviation = -20,
               max_ppm_deviation = 20,
               max_ipq = 0.2,
               min_sn = 9,
               group_to_filter = "Spike",
               sample_type_to_filter = "CN")

curate_spectra(data = long_data,
                                min_ppm_deviation = 0,
                                max_ppm_deviation = 0,
                                max_ipq = 0,
                                min_sn = 10000,
                                group_to_filter = "Spike",
                                sample_type_to_filter = "CN")

curated_spectra <- long_data %>% 
  dplyr::filter(passed_curation == TRUE)

```

```{r visualization}

long_data %>%  
  dplyr::group_by(sample_type, group, passed_curation, sample_name, charge) %>% 
  dplyr::count(sample_name, charge) %>% 
  ggplot2::ggplot() +
  ggplot2::geom_bar(ggplot2::aes(x = sample_type, fill = passed_curation), position = "fill") +
  ggplot2::facet_wrap(~ group) +
  ggplot2::xlab("Sample type") +
  ggplot2::scale_y_continuous(labels = function(x) paste0(x * 100, "%"), 
                              name = "Proportion of spectra (%)") +
  ggplot2::scale_fill_discrete(name = "Passed curation?", labels = c(`TRUE`= "Yes",
                                                                       `FALSE` = "No")) +
  ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
                 strip.background = ggplot2::element_rect(fill = "#F6F6F8")) +
  ggpubr::border(size = 0.5)

```

