---
title: "Traits"
author: ""
output: 
  pdf_document:
    highlight: breezedark
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(readxl)
```

```{r}
normalized_data <- read_excel("normalized_data.xlsx")
normalized_data_wide <- read_excel("normalized_data_wide.xlsx")
```

```{r}
source("R/fct_derived_traits.R")
```

```{r}
human_IgG_traits_ui <- c(
  "Fucosylation of complex-type glycans",
  "Bisection of complex-type glycans",
  "Galactosylation of complex-type glycans",
  "Sialylation of complex type-glycans",
  "Percentage of monoantennary complex-type glycans",
  "Percentage of hybrid-type glycans",
  "Oligomannose-type glycans: average number of mannoses"
  # (5 * H5N2 + 6 * H6N2 + ...) / (H5N2 + H6N2 + ...)
)

human_IgG_traits <- c(
  "fucosylation",
  "bisection",
  "galactosylation",
  "sialylation",
  "mono_antennary",
  "hybrid",
  "high_mannose"
)
```

```{r}
human_IgG_clusters <- c("IgGI", "IgGII")
# normalized_data also contains IgGIsil, but want to calculate for IgGI and IgGII
```

```{r}
load("./data/human_IgG_ref.rda")
```

```{r}
# Create an empty list to store the traits formulas of all clusters
formula_lists <- vector("character", length(human_IgG_clusters))

# Loop over the selected clusters
for (i in seq(length(human_IgG_clusters))) {
  cluster_name <- human_IgG_clusters[[i]]
  # Create an empty list to store the traits formulas for the cluster
  cluster_trait_formulas <- vector("character", length(human_IgG_traits))
  # Get the normalized data for the cluster
  cluster_normalized_data <- normalized_data %>% 
    dplyr::filter(cluster == cluster_name)
  # Get all analytes/glycans in the cluster
  cluster_analytes <- unique(cluster_normalized_data$analyte)
  cluster_glycans <- stringr::str_remove(cluster_analytes, paste0(cluster_name, "1"))
  # Get a subset of the reference file with only the passing analytes
  cluster_ref <- human_IgG_ref %>% 
    dplyr::filter(glycan %in% cluster_glycans)
  # Loop over the chosen traits
  for (j in seq(length(human_IgG_traits))) {
    trait <- human_IgG_traits[[j]]
    trait_formula <- generate_formula(cluster_name, cluster_ref, trait)
    cluster_trait_formulas[j] <- trait_formula
  }
  # Add the formulas for this cluster to formula_list
  formula_lists[i] <- list(cluster_trait_formulas)
}
```

```{r}
# Get one list with all trait formulas
all_formulas <- purrr::reduce(formula_lists, c)  # c = concatenate
```

```{r}
# Initiate an empty vector for the trait names
trait_names <- vector("character", length = length(all_formulas))

# Loop over the formulas and create a new column with traits
normalized_data_wide_with_traits <- normalized_data_wide
for (i in seq(length(all_formulas))) {
  formula <- all_formulas[[i]]
  expr_ls <- create_expr_ls(formula) 
  trait_names[[i]] <- names(expr_ls)
  normalized_data_wide_with_traits <- normalized_data_wide_with_traits %>% 
    dplyr::mutate(!!! expr_ls)
}

# Relocate the trait columns
normalized_data_wide_with_traits <- normalized_data_wide_with_traits %>% 
  dplyr::relocate(tidyselect::all_of(trait_names), .after = replicates)
```
