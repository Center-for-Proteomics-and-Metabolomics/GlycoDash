---
title: "glycodash_spectra_curation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{glycodash_spectra_curation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}

#library(glycodash)
devtools::load_all()

data("long_data")
```

```{r check_criteria}

# Now I'm using the negative controls that were uncalibrated (or for other reason NA)
# as 0 in the calculation of cut-offs (because I replace NAs in the criteria check 
# with FALSE). Is that what we want?

long_data <- curate_spectra(data = long_data,
                            min_ppm_deviation = -20,
                            max_ppm_deviation = 20,
                            max_ipq = 0.2,
                            min_sn = 9,
                            clusters_regex = "IgGI1",
                            group_to_filter = "Spike",
                            sample_type_to_filter = "CN")

curated_spectra <- long_data %>% 
  dplyr::filter(passed_curation == TRUE)

```

```{r visualization}

long_data %>%  
  ggplot2::ggplot() +
  ggplot2::geom_bar(ggplot2::aes(x = sample_type, fill = passed_curation), position = "fill") +
  ggplot2::facet_wrap(cluster ~ group) +
  ggplot2::xlab("Sample type") +
  ggplot2::scale_y_continuous(labels = function(x) paste0(x * 100, "%"), 
                              name = "Proportion of spectra (%)") +
  ggplot2::scale_fill_discrete(name = "Passed curation?", labels = c(`TRUE`= "Yes",
                                                                       `FALSE` = "No")) +
  ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
                 strip.background = ggplot2::element_rect(fill = "#F6F6F8")) +
  ggpubr::border(size = 0.5)

# long_data %>% 
#   dplyr::group_by(sample_type, group, passed_curation) %>% 
#   dplyr::summarise(n = length(unique(sample_name)))

```

```{r analyte-curation-based-on-data}
# User inputs:
groups_to_ignore <- "Total"
sample_types_to_ignore <- c("pool", "IVIGg", "CN", "Visucon", "PBS")
cut_off_perc <- 25

# Analyte curation:
curated_analytes <- curated_spectra %>% 
  dplyr::mutate(criteria_check = do_criteria_check(curated_spectra,
                                                   min_ppm_deviation = -20,
                                                   max_ppm_deviation = 20,
                                                   max_ipq = 0.2,
                                                   min_sn = 9)) %>% 
  dplyr::filter(!(group %in% groups_to_ignore) & !(sample_type %in% sample_types_to_ignore)) %>% 
  dplyr::group_by(cluster, charge, analyte) %>% 
  dplyr::summarise(passing_percentage = sum(criteria_check) / dplyr::n() * 100) %>% 
  dplyr::filter(passing_percentage > cut_off_perc)

analyted_curated_data <- dplyr::left_join(curated_analytes, curated_spectra)
  
```

